<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: bash | All Abouts]]></title>
  <link href="http://balta2ar.github.io/blog/categories/bash/atom.xml" rel="self"/>
  <link href="http://balta2ar.github.io/"/>
  <updated>2013-11-23T17:56:37+04:00</updated>
  <id>http://balta2ar.github.io/</id>
  <author>
    <name><![CDATA[Yuri Bochkarev]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Bandwidth shaping in Linux]]></title>
    <link href="http://balta2ar.github.io/blog/2013/11/23/bandwidth-shaping-in-linux/"/>
    <updated>2013-11-23T17:01:00+04:00</updated>
    <id>http://balta2ar.github.io/blog/2013/11/23/bandwidth-shaping-in-linux</id>
    <content type="html"><![CDATA[<p>It's always been a problem for me to shape traffic in Linux. After Windows
experience with Outpost firewall I couldn't find an easy and convenient way
to shape traffic in Linux. Judging by the amount of similar questions over
the Internet it's unobvious not only to me but to many other users.</p>

<!-- more -->


<p>It appears there are different ways to achieve that in Linux. I personally found
two of them useful: <a href="http://monkey.org/~marius/pages/?page=trickle">trickle</a> and <a href="http://tldp.org/HOWTO/Traffic-Control-HOWTO/intro.html">tc</a>.</p>

<h2>trickle</h2>

<p><code>trickle</code> is simple and easy to use, just run the program you want to limit
and specify the bandwith:</p>

<p>```
$ trickle -d 20kb wget http://mirror.rol.ru/archlinux/iso/2013.11.01/archlinux-2013.11.01-dual.iso
trickle: Could not reach trickled, working independently: No such file or directory
--2013-11-23 17:09:37--  http://mirror.rol.ru/archlinux/iso/2013.11.01/archlinux-2013.11.01-dual.iso
Resolving mirror.rol.ru (mirror.rol.ru)... 194.67.1.114
Connecting to mirror.rol.ru (mirror.rol.ru)|194.67.1.114|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 541065216 (516M) [application/octet-stream]
Saving to: ‘archlinux-2013.11.01-dual.iso’</p>

<p> 0% [                                                                                      ] 144,540     20.0KB/s  eta 5h 53m
```</p>

<p><code>trickle</code> works in userspace. It takes advantage of the unix loader preloading
functionality to intercept <code>read</code>/<code>write</code> calls. See the <a href="http://monkey.org/~marius/trickle/trickle.pdf">paper</a> for the
details.</p>

<h2>tc</h2>

<p>tc is a different beast. It's quite a complex thing for a newbie like me though
it's powerful. tc allows you to create intricate rules to shape your traffic.
The problem is that only outgoing traffic can be shaped in a graceful way. In
incoming traffic you can only brutally drop packets.</p>

<p>This is nasty but luckily there is a way around called <a href="http://www.linuxfoundation.org/collaborate/workgroups/networking/ifb">The Intermediate
Functional Block device</a>. With this module you can reroute incoming traffic
from ifb device to eth0 so that the traffic will be treated as outgoing when
leaving ifb.</p>

<p>I should've propably taken a weekend to dig really deep into tc functionality
and master it but instead I went the easy way. After googling for a while I
found this brilliant question/answer and this script:</p>

<ul>
<li><a href="http://serverfault.com/questions/350023/tc-ingress-policing-and-ifb-mirroring">Tc: ingress policing and ifb mirroring</a></li>
<li><a href="https://github.com/rfrail3/misc/blob/master/tc/traffic-control.sh">traffic-control.sh</a></li>
</ul>


<p>Inspired by this two wonderful sources I came up with my own version:</p>

<p>``` bash bandwidth.sh</p>

<h1>!/bin/sh</h1>

<p>#</p>

<h1>$1 -- incoming bandwidth</h1>

<h1>$2 -- outgoing bandwidth</h1>

<p>#</p>

<h1>bandwidth.sh init -- modprobe &amp;&amp; ip up</h1>

<h1>bandwidth.sh x y  -- set incoming bandwidth to x, outgoing to y</h1>

<h1>bandwidth.sh      -- remove limits</h1>

<h1>bandwidth.sh - y  -- remove incoming limits, set outgoing limit</h1>

<p>#</p>

<h1>init</h1>

<h1>modprobe ifb numifbs=1</h1>

<h1>ip link set dev ifb0 up # repeat for ifb1, ifb2, ...</h1>

<p>PHY=eth0
VIR=ifb0
IN=$1
OUT=$2</p>

<p>function go() {</p>

<pre><code>echo "$*"
eval "$*"
return $?
</code></pre>

<p>}</p>

<p>if [ $# -eq 1 ]; then</p>

<pre><code>if [ $1 == "init" ]; then
    echo "Initializing"
    go modprobe ifb numifbs=1
    go ip link set dev ifb0 up
    exit 0
fi
</code></pre>

<p>fi</p>

<p>[ "$IN" == "-" ] &amp;&amp; IN=
[ "$OUT" == "-" ] &amp;&amp; OUT=</p>

<p>go tc qdisc del dev $PHY root       # clear outgoing
go tc qdisc del dev $PHY ingress    # clear incoming
go tc qdisc del dev $VIR root       # clean incoming</p>

<p>[ $# -eq 0 ] &amp;&amp; exit 0</p>

<p>go tc qdisc add dev $PHY handle ffff: ingress
go tc filter add dev $PHY parent ffff: protocol ip u32 match u32 0 0 action mirred egress redirect dev ifb0</p>

<p>if [ -n "$IN" ]; then</p>

<pre><code># incoming
go tc qdisc add dev $VIR root handle 1: htb default 10
go tc class add dev $VIR parent 1: classid 1:1 htb rate $IN
go tc class add dev $VIR parent 1:1 classid 1:10 htb rate $IN
</code></pre>

<p>fi</p>

<p>if [ -n "$OUT" ]; then</p>

<pre><code># outgoing
go tc qdisc add dev $PHY root handle 1: htb default 10
go tc class add dev $PHY parent 1: classid 1:1 htb rate $OUT
go tc class add dev $PHY parent 1:1 classid 1:10 htb rate $OUT
</code></pre>

<p>fi
```</p>

<p>You can also get the script <a href="https://gist.github.com/balta2ar/7614370">here</a>. Now traffic shaping is a matter of
a couple of calls:</p>

<p><code>bash
sudo bandwidth.sh init          # load ifb kernel module
sudo bandwidth.sh 100kbps       # set incoming limit
sudo bandwidth.sh - 200kbps     # remove incoming limit, set outgoing limit
sudo bandwidth.sh 10kbps 20kbps # set both incoming &amp; outgoing limits
</code></p>

<p>The only thing that I miss now is shaping traffic for each process individually
and changing limits on the fly.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Download iTunes U Course - The Hacker Way]]></title>
    <link href="http://balta2ar.github.io/blog/2013/10/13/download-itunes-u-course-the-hacker-way/"/>
    <updated>2013-10-13T13:48:00+04:00</updated>
    <id>http://balta2ar.github.io/blog/2013/10/13/download-itunes-u-course-the-hacker-way</id>
    <content type="html"><![CDATA[<p>Today, kids, we are going to download iTunes U course almost exclusively from
the command line.</p>

<!-- more -->


<h2>Why</h2>

<p>The easiest way to do that is to use iTunes to download all that for you.
Unfortunately, while I have iPod/iPad in my home ecosystem, I don't have any
Mac computers. Thus, I'm running iTunes in a virtual machine on Windows.
Imagine my user experience from such combination. Pure pain and suffering.</p>

<p>There wouldn't be this post if it was all smooth. For unknown reasons my iTunes
doesn't save downloaded video files. I can see it's downloading them, I can
see the temp file growing, but when it's done, puff, I can't find the file
anywhere. Luckily, there is a solution. It is a pity but you still need iTunes
for a couple of steps.</p>

<h2>How</h2>

<p>OK, let's do it. Say, you found an interesting course on iTunes U:</p>

<p><img src="./ml.png"></p>

<h3>Step 1. Subscribe to the course in iTunes</h3>

<h3>Step 2. Copy course url</h3>

<p>Click on any item in the course materials list and
select "Copy iTunes U URL".</p>

<p><img src="./copy-url.png"></p>

<p>NB: There is <a href="https://itunesu.itunes.apple.com/coursemanager/">iTunes U Course Manager</a>
web page and I presume you might get the feed URL there (though I really doubt
you can). However, my country isn't enjoying Apple's favour.</p>

<p><img src="./bad-country.png"></p>

<h3>Step 3. Download the feed</h3>

<p><code>
wget -O list.xml https://p1-u.itunes.apple.com/WebObjects/LZStudent.woa/ra/feed/CODBABB3ZC
</code></p>

<h3>Step 4. Extract links and titles</h3>

<p>The feed contains <code>feed/entry</code> items in the format as follows:</p>

<p>``` xml
&lt;?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xmlns:itms="http://www.itunes.com/dtds/itunesu-1.0.dtd"></p>

<pre><code>&lt;title type="text"&gt;Machine Learning&lt;/title&gt;
&lt;subtitle type="text"&gt;&amp;lt;div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;strong&amp;gt;A real Caltech course...&lt;/subtitle&gt;
&lt;updated&gt;2013-06-12T00:19:12PDT&lt;/updated&gt;
&lt;link rel="alternate" type="text/html"
      href="https://p1-u.itunes.apple.com/WebObjects/LZStudent.woa/ra/courses/CODBABB3ZC"/&gt;
&lt;id&gt;1/CODBABB3ZC&lt;/id&gt;
&lt;itms:courseid&gt;CODBABB3ZC&lt;/itms:courseid&gt;
&lt;itms:auditUrl&gt;https://itunesu.itunes.apple.com/audit/CODBABB3ZC&lt;/itms:auditUrl&gt;


&lt;entry&gt;
    &lt;author&gt;
        &lt;name&gt;Dr. Yaser Abu-Mostafa&lt;/name&gt;
    &lt;/author&gt;
    &lt;title type="html"&gt;&lt;![CDATA[AC___Lecture 01 slides]]&gt;&lt;/title&gt;
    &lt;id&gt;1/CODBABB3ZC/MAES7ECEVA&lt;/id&gt;
    &lt;updated&gt;2013-06-11T23:25:24PDT&lt;/updated&gt;
    &lt;published&gt;2012-06-14T15:07:36PDT&lt;/published&gt;
    &lt;summary type="html"&gt;&lt;![CDATA[AC___Lecture 01 slides]]&gt;&lt;/summary&gt;
    &lt;link rel="enclosure" type="application/pdf"
          href="http://a1372.phobos.apple.com/us/r30/CobaltPublic/v4/35/56/6a/35566a02-1e0a-3db8-17e2-69be6445ba9b/208-5815754981465838988-ACsld01.pdf"
length="300673"/&gt;
&lt;/entry&gt;
</code></pre>

<p>...
```</p>

<p>It is very convenient to use <a href="http://xmlstar.sourceforge.net/doc/UG/xmlstarlet-ug.html">xmlstartlet</a>
to extract titles and links from the feed. Note, however, that xmlstartlet is
very picky to namespace (thanks to <a href="http://stackoverflow.com/questions/9025492/xmlstarlet-does-not-select-anything">this</a>
answer). Extraction command will look as follows:</p>

<p><code>
xml sel -N x="http://www.w3.org/2005/Atom" -t -m //x:entry -v x:title -o "|" -v x:link/@href -n list.xml &gt; fmt.txt
</code></p>

<h3>Step 5. Download the course</h3>

<p>Now all that is left is to read titles and links and
download them. I prefer to use <a href="http://aria2.sourceforge.net/">aria2c</a></p>

<p><code>
IFS='|' &amp;&amp; while read a b; do n=$a.${b##*.}; aria2c --allow-overwrite=false --auto-file-renaming=false -o $n $b; done &lt; fmt.txt
</code></p>

<p><code>${b##*.}</code> is a command to get filename extension (see <a href="http://stackoverflow.com/questions/965053/extract-filename-and-extension-in-bash">this</a>
and <a href="http://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html#Shell-Parameter-Expansion">this</a>)</p>

<h2>References</h2>

<ol>
<li><a href="http://alistairisrael.wordpress.com/2007/09/26/querying-an-xml-document-using-xmlstarlet/">Querying an XML document using XMLStarlet</a></li>
<li><a href="http://xmlstar.sourceforge.net/doc/UG/xmlstarlet-ug.html">XmlStarlet Command Line XML Toolkit User's Guide</a></li>
<li><a href="http://www.freesoftwaremagazine.com/articles/xml_starlet">XMLStarlet: a Unix toolkit for XML</a></li>
</ol>

]]></content>
  </entry>
  
</feed>
